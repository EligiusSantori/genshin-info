<!doctype html>

<html lang="en">
	<head>
	<meta charset="utf-8">
	<title>Characters rerun retentions.</title>
	<meta name="description" content="Genshin Impact characters rerun retentions.">
	<meta name="author" content="MirrorImage">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap-reboot.min.css" integrity="sha256-fjdlYyQyUwnf7m25DM18I325nnS2LbN7gdHPrq+OCyc=" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/moment@2.29.3/moment.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/ractive"></script>
	<script defer="defer" src="js/index.js"></script>
	<style>
		:root {
			--grade4-color: rgba(154,112,175,1);
			--grade5-color: rgba(193,117,33,1);
			--grade4-st-color: rgba(154,112,175,0.7);
			--grade5-st-color: rgba(193,117,33,0.7);
		}
		html, body, #content, table { height: 100%; padding: 0; margin: 0; }
		table { width: 100%; overflow: hidden; border: none; font-size: x-small; line-height: 1; }
		th, td {
			border: thin #777 solid;
			padding: 0;
			text-align: center;
			vertical-align: middle;
			position: relative;
		}
		td { color: #333; }
		.now { color: white; }
		.now .value { position: absolute; left: 0; top: 0; }
		/* td:not(.now) { font-style: italic; } */
		tr:first-of-type th:first-child { width: 10em; }
		tr[data-grade="4"] { background-color: var(--grade4-st-color); }
		tr[data-grade="5"] { background-color: var(--grade5-st-color); }
		tr[data-grade="4"] th { background-color: var(--grade4-color); }
		tr[data-grade="5"] th { background-color: var(--grade5-color); }
		tr[data-grade="4"] .now .value { background-color: #99cc66; }
		tr[data-grade="5"] .now .value { background-color: #33cc00; font-weight: bold; }

		thead { line-height: 1.5; background-color: #666666; color: white; }
		thead th { background-color: #666666; border-color: #999999; }

		.hover th:hover:before, .hover th:hover:after, .hover td:hover:before, .hover td:hover:after {
			content: '';
			display: block;
			position: absolute;
			z-index: 1;
			background-color: #dd9;
		}
		tbody th:hover:before, td:hover:before { width: 200vw; height: 100%; left: -100vw; top: 0; }
		thead tr:not(:first-of-type) th:hover:after, td:hover:after { width: 100%; height: 200vh; left: 0; top: -100vh; }
		thead tr:first-child th { z-index: 100; border-top: none; }
		.value { display: flex; width: 100%; height: 100%; justify-content: center; align-items: center; position: relative; z-index: 2; }
	</style>
</head>

<body>
	<article id="content"></article>
	<script id="layout" type="text/ractive">
		<table class-hover="highlight">
			<thead>
				<tr>
					<th rowspan="2">
						<label><input type="checkbox" checked="{{highlight}}" /> Hover</label>
						<label><input type="checkbox" checked="{{sort.grade}}" />&darr;Grade</label><br/>
						<select value={{sort.type}}>
							<option value="alphabet">&darr;Name</option><!-- By character name. -->
							<option value="release">&darr;Release</option><!-- By release date. -->
							<option value="delay">&darr;Delay</option><!-- By current re-run delay. -->
							<option value="average">&darr;Average</option><!-- By average re-run delay. -->
							<option value="rerun">&darr;Re-runs</option><!-- By re-runs count. -->
						</select>
					</th>
					{{#each years}}<th colspan="{{.}}">{{@key}}</th>{{/each}}
				</tr>
				<tr>{{#each banners: i}}<th><span class="value">{{start.format('MM-DD')}}</span></th>{{/each}}</tr>
			</thead>
			<tbody>
			{{#each data as r}}
				{{#unless excluded.includes(r[0].name)}}
				<tr data-grade="{{r[0].grade}}">
				{{#each r as v: i}}
					{{#if i == 0}}
					<th><span class="value">{{v.name}}</span></th>
					{{elseif v >= 0}}
					<td style="background-color: rgba(204, 0, 0, {{v/365}})"><span class="value">{{v}}</span></td>
					{{elseif v < 0}}
					<td class="now"><span class="value">{{-v}}</span></td>
					{{else}}
					<td><span class="value"></span></td>
					{{/if}}
				{{/each}}
				</tr>
				{{/unless}}
			{{/each}}
			</tbody>
		</table>
	</script>
	<script type="text/javascript">
		window.onload = function() {
			db.banners.forEach(b => b.start = moment(b.start));
			function order(by, banners) {
				let byRelease = c => _.invoke(banners.find(b => b.characters.includes(c.name)), 'start.valueOf') || Number.POSITIVE_INFINITY;
				let byDelay = c => _.invoke(_.findLast(banners, b => b.characters.includes(c.name)), 'start.valueOf') || Number.POSITIVE_INFINITY;
				let byAverage = c => (r => r.length ? r.length / moment().diff(r[0].start) : Number.POSITIVE_INFINITY)
					(banners.filter(b => b.characters.includes(c.name)));
				let byRerun = c => -banners.filter(b => b.characters.includes(c.name)).length;
				let byGrade = c => -c.grade;
				let how =
					(by.type == 'alphabet' && !by.grade) ? ['name'] :
					(by.type == 'alphabet' && by.grade) ? [byGrade, 'name'] :
					(by.type == 'release' && !by.grade) ? [byRelease, byGrade, 'name'] :
					(by.type == 'release' && by.grade) ? [byGrade, byRelease, 'name'] :
					(by.type == 'delay' && !by.grade) ? [byDelay, byGrade, 'name'] :
					(by.type == 'delay' && by.grade) ? [byGrade, byDelay, 'name'] :
					(by.type == 'average' && !by.grade) ? [byAverage, byGrade, 'name'] :
					(by.type == 'average' && by.grade) ? [byGrade, byAverage, 'name'] :
					(by.type == 'rerun' && !by.grade) ? [byRerun, byGrade, 'name'] :
					(by.type == 'rerun' && by.grade) ? [byGrade, byRerun, 'name'] :
					[];
				return how;
			}
			function table(characters, banners) {
				// console.log(Date.now());
				let data = new Array(characters.length);
				for(let i = 0; i < data.length; i++) {
					let row = new Array(banners.length + 1);
					let character = row[0] = characters[i];
					for(let j = 1, r = 0, p = undefined; j < row.length; j++) {
						let banner = banners[j - 1];
						if(banner.characters.includes(character.name)) {
							p = j;
							row[j] = --r;
						} else if(p) {
							row[j] = p == j ? 0 : banner.start.diff(banners[p].start, 'days');
						}
					}
					data[i] = row;
				}
				return data;
			}
			function update() {
				this.set('data', table(_.sortBy(db.characters, order(this.get('sort'), db.banners)), db.banners));
			}

			var ractive = new Ractive({
				target: '#content',
				template: '#layout',
				data: {
					excluded: ["Aloy", "Jean", "Mona", "Qiqi", "Diluc", "Keqing", "Amber", "Kaeya", "Lisa"],
					banners: db.banners,
					data: {},
					sort: {
						type: 'alphabet',
						grade: false,
					},
					highlight: false,
				},
				computed: {
					years: function() {
						let years = {};
						this.get('banners').map(b => b.start.year())
							.forEach(y => years[y] ? years[y]++ : years[y] = 1);
						return years;
					},
				},
				onconfig: update,
				observe: {
					'sort.type sort.grade': {
						handler: update,
						init: false,
					},
				},
			});
		}
	</script>
</body>
</html>
